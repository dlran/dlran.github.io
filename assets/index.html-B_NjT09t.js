import{_ as s,c as e,a,o as l}from"./app-CXOWP-6d.js";const h={};function d(n,i){return l(),e("div",null,i[0]||(i[0]=[a(`<h2 id="一、准备工作" tabindex="-1"><a class="header-anchor" href="#一、准备工作"><span>一、准备工作</span></a></h2><p>确保你已经安装并配置好了以下组件：</p><ul><li><strong>KVM/QEMU</strong></li><li><strong>libvirt 管理工具</strong></li><li>一个已创建并正在运行的虚拟机（例如 <code>rhel7</code>）</li></ul><hr><h2 id="二、创建一个新的-qcow2-格式磁盘镜像" tabindex="-1"><a class="header-anchor" href="#二、创建一个新的-qcow2-格式磁盘镜像"><span>二、创建一个新的 QCOW2 格式磁盘镜像</span></a></h2><p>使用 <code>qemu-img</code> 命令创建一个大小为 2G 的 qcow2 格式磁盘镜像：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">qemu-img</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qcow2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /home/vm/rhel2G.qcow2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 2G</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>说明：</p><ul><li><code>-f qcow2</code>：指定磁盘格式为 qcow2（支持快照、压缩、稀疏存储等特性）</li><li><code>rhel2G.qcow2</code>：新磁盘的名称</li><li><code>2G</code>：磁盘大小</li></ul><p>创建成功后，会在 <code>/home/vm</code> 目录下生成一个空白的 2G 虚拟磁盘文件。</p><hr><h2 id="三、将磁盘挂载到虚拟机" tabindex="-1"><a class="header-anchor" href="#三、将磁盘挂载到虚拟机"><span>三、将磁盘挂载到虚拟机</span></a></h2><p>使用 <code>virsh attach-disk</code> 命令将新磁盘动态挂载到名为 <code>rhel7</code> 的虚拟机上：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">virsh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> attach-disk</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rhel7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /home/vm/rhel2G.qcow2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vdb</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --subdriver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qcow2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cache</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> none</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --persistent</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>参数说明：</p><ul><li><code>rhel7</code>：目标虚拟机名称</li><li><code>/home/vm/rhel2G.qcow2</code>：要挂载的磁盘路径</li><li><code>vdb</code>：在虚拟机中的设备名（通常第一个磁盘是 vda，第二个可以用 vdb）</li><li><code>--subdriver qcow2</code>：指定磁盘子驱动类型（必须与磁盘格式一致）</li><li><code>--cache none</code>：禁用缓存，确保数据写入磁盘</li><li><code>--persistent</code>：将该变更写入虚拟机的配置文件，确保重启后仍然有效</li></ul><p>挂载完成后，可以在虚拟机内通过 <code>lsblk</code>、<code>fdisk -l</code> 或 <code>dmesg</code> 命令查看新磁盘。</p><hr><h2 id="四、从虚拟机中卸载磁盘" tabindex="-1"><a class="header-anchor" href="#四、从虚拟机中卸载磁盘"><span>四、从虚拟机中卸载磁盘</span></a></h2><p>当不再需要该磁盘时，可以使用 <code>virsh detach-disk</code> 命令将其从虚拟机中移除：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">virsh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> detach-disk</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --domain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vmname</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /home/vm/vmname-vdb.qcow2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --persistent</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>说明：</p><ul><li><code>--domain vmname</code>：指定要操作的虚拟机名称</li><li><code>/home/vm/vmname-vdb.qcow2</code>：要卸载的磁盘路径</li><li><code>--persistent</code>：从配置文件中永久移除该磁盘</li></ul><p>请确保卸载前虚拟机内部没有正在使用该磁盘（比如挂载点未卸载），否则可能会导致系统异常或数据损坏。</p><hr><h2 id="四、从虚拟机中卸载磁盘-1" tabindex="-1"><a class="header-anchor" href="#四、从虚拟机中卸载磁盘-1"><span>四、从虚拟机中卸载磁盘</span></a></h2><p>当不再需要该磁盘时，可以使用 <code>virsh detach-disk</code> 命令将其从虚拟机中移除：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">virsh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> detach-disk</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --domain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vmname</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /home/vm/vmname-vdb.qcow2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --persistent</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>说明：</p><ul><li><code>--domain vmname</code>：指定要操作的虚拟机名称</li><li><code>/home/vm/vmname-vdb.qcow2</code>：要卸载的磁盘路径（根据实际路径替换）</li><li><code>--persistent</code>：从虚拟机配置中永久移除该磁盘</li></ul><blockquote><p>💡 提醒：在卸载前，请先确保虚拟机内部没有正在使用该磁盘（如没有被挂载到某个路径），否则可能导致文件系统异常或数据损坏。</p></blockquote><hr><h2 id="五、验证虚拟机磁盘列表" tabindex="-1"><a class="header-anchor" href="#五、验证虚拟机磁盘列表"><span>五、验证虚拟机磁盘列表</span></a></h2><p>磁盘卸载之后，你可以使用以下命令验证虚拟机当前挂载的所有磁盘设备：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">virsh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> domblklist</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vmname</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>示例输出：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>Target     Source</span></span>
<span class="line"><span>------------------------------------------------</span></span>
<span class="line"><span>vda        /var/lib/libvirt/images/rhel7.qcow2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明：</p><ul><li><code>Target</code>：虚拟机中看到的设备名称（如 vda、vdb）</li><li><code>Source</code>：磁盘对应的宿主机文件路径</li></ul><p>如果卸载成功，<code>vdb</code> 等对应项将不再显示在列表中。</p><hr><h2 id="六、小贴士" tabindex="-1"><a class="header-anchor" href="#六、小贴士"><span>六、小贴士</span></a></h2><ul><li>如果要在虚拟机内部确认磁盘状态，也可以登录虚拟机使用命令：</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  lsblk</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>若卸载磁盘后计划删除磁盘文件，可直接执行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rm</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /home/vm/rhel2G.qcow2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>⚠️ 注意：删除前务必确认该磁盘不再被其他虚拟机使用。</p></blockquote></li></ul>`,45)]))}const r=s(h,[["render",d]]),c=JSON.parse('{"path":"/article/4cacac05/","title":"KVM虚拟机添加和移除虚拟磁盘","lang":"zh-CN","frontmatter":{"title":"KVM虚拟机添加和移除虚拟磁盘","tags":["Linux"],"createTime":"2023/08/16 08:56:02","permalink":"/article/4cacac05/"},"readingTime":{"minutes":2.69,"words":806},"git":{},"filePathRelative":"Operations/4cacac05.md","headers":[],"categoryList":[{"id":"456d0d","sort":10001,"name":"Operations"}]}');export{r as comp,c as data};
